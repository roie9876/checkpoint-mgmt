{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "allowedValues": [
        "swedencentral",
        "swedensouth",
        "westeurope",
        "northeurope",
        "eastus",
        "eastus2",
        "westus3"
      ],
      "defaultValue": "swedencentral",
      "metadata": {
        "description": "Deployment location (Azure region)"
      }
    },
    "availabilityZone": {
      "type": "string",
      "allowedValues": [
        "1",
        "2",
        "3"
      ],
      "defaultValue": "1",
      "metadata": {
        "description": "Availability Zone for zonal deployment (required for Premium SSD v2)"
      }
    },
    "cloudGuardVersion": {
      "type": "string",
      "allowedValues": [
        "R81.10 - Bring Your Own License",
        "R81.10 - Pay As You Go (MGMT25)",
        "R81.20 - Bring Your Own License",
        "R81.20 - Pay As You Go (MGMT25)",
        "R82 - Bring Your Own License",
        "R82 - Pay As You Go (MGMT25)"
      ],
      "defaultValue": "R82 - Pay As You Go (MGMT25)",
      "metadata": {
        "description": "Version of Check Point CloudGuard"
      }
    },
    "authenticationType": {
      "type": "string",
      "allowedValues": [
        "password",
        "sshPublicKey"
      ],
      "defaultValue": "password",
      "metadata": {
        "description": "Authentication type"
      }
    },
    "sshPublicKey": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Administrator SSH public key"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Administrator password"
      },
      "defaultValue": ""
    },
    "MaintenanceModePasswordHash": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "Description": "Maintenance mode password hash, relevant only for R81.20 and higher versions"
      }
    },
    "SerialConsolePasswordHash": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "Description": "Optional parameter, used to enable serial console connection in case of SSH key as authentication type"
      }
    },
    "vmName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Check Point Security Gateway"
      }
    },
    "appendDeploymentSuffix": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "If true, append a deployment-unique suffix to VM-related resource names to avoid updating immutable properties like osProfile.customData on an existing VM."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D4ds_v5",
      "metadata": {
        "description": "Size of the VM"
      }
    },
    "virtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "The name of the virtual network"
      },
      "defaultValue": "vnet"
    },
    "virtualNetworkAddressPrefix": {
      "type": "string",
      "metadata": {
        "description": "The address prefix of the virtual network"
      },
      "defaultValue": "10.0.0.0/16"
    },
    "Subnet1Name": {
      "type": "string",
      "metadata": {
        "description": "The name of the 1st subnet"
      },
      "defaultValue": "Frontend"
    },
    "Subnet1Prefix": {
      "type": "string",
      "metadata": {
        "description": "The address prefix of the 1st subnet"
      },
      "defaultValue": "10.0.1.0/24"
    },
    "Subnet1StartAddress": {
      "type": "string",
      "metadata": {
        "description": "The first available address on the 1st subnet"
      },
      "defaultValue": "10.0.1.10"
    },
    "vnetNewOrExisting": {
      "type": "string",
      "defaultValue": "new",
      "allowedValues": [
        "new",
        "existing"
      ],
      "metadata": {
        "Description": "Indicates whether the virtual network is new or existing"
      }
    },
    "virtualNetworkExistingRGName": {
      "type": "string",
      "metadata": {
        "description": "Resource Group of the existing virtual network"
      },
      "defaultValue": "[resourceGroup().name]"
    },
    "managementGUIClientNetwork": {
      "type": "string",
      "metadata": {
        "description": "Allowed GUI clients"
      },
      "defaultValue": "0.0.0.0/0"
    },
    "installationType": {
      "type": "string",
      "metadata": {
        "description": "Installation Type"
      },
      "defaultValue": "management",
      "allowedValues": [
        "management",
        "custom"
      ]
    },
    "adminShell": {
      "type": "string",
      "defaultValue": "/bin/bash",
      "allowedValues": [
        "/etc/cli.sh",
        "/bin/bash",
        "/bin/csh",
        "/bin/tcsh"
      ],
      "metadata": {
        "Description": "The default shell for the admin user"
      }
    },
    "bootstrapScript": {
      "type": "string",
      "metadata": {
        "description": "Bootstrap script"
      },
      "defaultValue": "#!/bin/bash\n# Check Point GAiA (R82) bootstrap\n# Goal: put /var/log on a dedicated Premium SSD v2 disk (4K logical sectors)\n# and leave the OS disk untouched.\n#\n# IMPORTANT:\n# - This is intended for a FRESH deployment (safe to reformat the data disk).\n# - Assumes the *data disk* is attached as a new empty disk (no important data).\n#\n# Logging:\n# - Writes to /var/log/cp-bootstrap-varlog.log (after /var/log is mounted it continues there)\n# - Also logs to syslog via logger\n# - Creates /var/log/cp-bootstrap-varlog.SUCCESS on success\n\nset -euo pipefail\n\nLOG=\"/var/log/cp-bootstrap-varlog.log\"\nexec > >(tee -a \"$LOG\" | logger -t cp-bootstrap) 2>&1\n\necho \"BOOTSTRAP START: $(date -Is)\"\necho \"Kernel: $(uname -a)\"\necho \"Whoami: $(id || true)\"\necho \"PATH: $PATH\"\n\n# ----------------------------\n# Helpers\n# ----------------------------\nlog() {\n  echo \"$*\" >&2\n}\n\nfail() {\n  echo \"BOOTSTRAP FAIL: $(date -Is) :: $*\"\n  exit 1\n}\n\nis_mounted() {\n  mountpoint -q \"$1\"\n}\n\nget_mount_source() {\n  local mnt=\"$1\"\n  if command -v findmnt >/dev/null 2>&1; then\n    findmnt -n -o SOURCE \"$mnt\" 2>/dev/null || true\n  else\n    mount | awk -v m=\"$mnt\" '$3==m {print $1; exit}'\n  fi\n}\n\nget_xfs_sectsz() {\n  xfs_info /var/log 2>/dev/null | tr ' ' '\\n' | awk -F= '$1==\"sectsz\"{print $2; exit}'\n}\n\nget_logical_sector_size() {\n  blockdev --getss \"$1\" 2>/dev/null || echo \"\"\n}\n\ndisk_has_mounted_partitions() {\n  local dev=\"$1\"\n  local base\n  base=\"$(basename \"$dev\")\"\n  # Skip disks with any mounted partition (avoid resource/OS disks).\n  awk -v b=\"$base\" '$1 ~ (\"/\" b \"[0-9]+$\") { found=1 } END { exit found?0:1 }' /proc/mounts 2>/dev/null\n}\n\nis_aligned_4k() {\n  local bytes=\"$1\"\n  [ -n \"$bytes\" ] || return 1\n  awk -v b=\"$bytes\" 'BEGIN { exit (b % 4096 == 0) ? 0 : 1 }'\n}\n\nwait_for_partitions() {\n  local dev=\"$1\"\n  if command -v partprobe >/dev/null 2>&1; then\n    partprobe \"$dev\" || true\n  fi\n  if command -v udevadm >/dev/null 2>&1; then\n    udevadm settle || true\n  fi\n}\n\nreport_final_layout() {\n  log \"Final layout summary:\"\n  if command -v lvs >/dev/null 2>&1; then\n    lvs -o lv_name,devices || true\n  fi\n  if command -v df >/dev/null 2>&1; then\n    df -h /var/log || true\n  fi\n}\n\nwait_for_blockdev() {\n  local dev=\"$1\"\n  local tries=\"${2:-60}\"\n  local sleep_s=\"${3:-2}\"\n  for i in $(seq 1 \"$tries\"); do\n    if [ -b \"$dev\" ]; then\n      return 0\n    fi\n    sleep \"$sleep_s\"\n  done\n  return 1\n}\n\nresolve_symlink() {\n  local path=\"$1\"\n  if command -v readlink >/dev/null 2>&1; then\n    readlink -f \"$path\"\n  else\n    echo \"$path\"\n  fi\n}\n\nget_part_path() {\n  local dev=\"$1\"\n  # Azure LUN symlinks expose partitions as lunX-partY.\n  if [[ \"$dev\" == /dev/disk/azure/scsi1/lun* ]]; then\n    echo \"${dev}-part1\"\n  else\n    echo \"${dev}1\"\n  fi\n}\n\nswapoff_if_active() {\n  local dev=\"$1\"\n  if [ -z \"$dev\" ]; then\n    return 0\n  fi\n  if grep -q \"^$dev[[:space:]]\" /proc/swaps 2>/dev/null; then\n    if command -v swapoff >/dev/null 2>&1; then\n      log \"Swap is active on $dev; disabling it.\"\n      swapoff \"$dev\" || return 1\n    else\n      log \"Swap is active on $dev but swapoff is not available.\"\n      return 1\n    fi\n  fi\n  return 0\n}\n\nextend_var_log_lvm() {\n  local data_disk=\"$1\"\n  local log_src vg_name lv_name lv_path part\n  local lv_size_mb pv_free_mb cur_pvs moved_ok\n\n  # Only handle cases where /var/log is an LVM LV already.\n  log_src=\"$(get_mount_source /var/log)\"\n  case \"$log_src\" in\n    /dev/mapper/*) ;;\n    *) return 1 ;;\n  esac\n\n  command -v lvs >/dev/null 2>&1 || return 1\n  command -v vgs >/dev/null 2>&1 || return 1\n  command -v pvs >/dev/null 2>&1 || return 1\n  command -v pvcreate >/dev/null 2>&1 || return 1\n  command -v vgextend >/dev/null 2>&1 || return 1\n  command -v lvextend >/dev/null 2>&1 || return 1\n  command -v xfs_growfs >/dev/null 2>&1 || return 1\n\n  vg_name=\"$(lvs --noheadings -o vg_name \"$log_src\" | awk '{print $1}')\"\n  lv_name=\"$(lvs --noheadings -o lv_name \"$log_src\" | awk '{print $1}')\"\n  [ -n \"$vg_name\" ] || return 1\n  [ -n \"$lv_name\" ] || return 1\n\n  part=\"$(get_part_path \"$data_disk\")\"\n  wait_for_blockdev \"$part\" 20 1 || return 1\n\n  swapoff_if_active \"$part\" || return 1\n  local data_ss pe_start_bytes\n  data_ss=\"$(get_logical_sector_size \"$(resolve_symlink \"$data_disk\")\")\"\n\n  # Create PV if missing; wipe signatures to avoid stale metadata conflicts.\n  if ! pvs --noheadings -o pv_name 2>/dev/null | awk '{print $1}' | grep -qx \"$part\"; then\n    if blkid \"$part\" >/dev/null 2>&1; then\n      log \"Wiping existing signatures on $part for LVM use...\"\n      if command -v wipefs >/dev/null 2>&1; then\n        wipefs -a \"$part\"\n      else\n        dd if=/dev/zero of=\"$part\" bs=1M count=10\n      fi\n    fi\n    log \"Creating LVM PV on $part\"\n    if [ -n \"$data_ss\" ] && [ \"$data_ss\" -ge 4096 ]; then\n      # Premium SSD v2 uses 4K logical sectors; enforce 4K PV alignment.\n      pvcreate --dataalignment 4K -ff -y \"$part\"\n    else\n      pvcreate -ff -y \"$part\"\n    fi\n  fi\n\n  if [ -n \"$data_ss\" ] && [ \"$data_ss\" -ge 4096 ]; then\n    pe_start_bytes=\"$(pvs --noheadings --units b -o pe_start \"$part\" 2>/dev/null | tr -d ' B')\"\n    if ! is_aligned_4k \"$pe_start_bytes\"; then\n      # Fail early instead of letting pvmove hang with misaligned I/O.\n      fail \"PV on $part is not 4K aligned (pe_start=${pe_start_bytes}B). Recreate PV with --dataalignment 4K.\"\n    fi\n  fi\n\n  if ! pvs --noheadings -o pv_name,vg_name 2>/dev/null | awk '{print $1\":\"$2}' | grep -qx \"$part:$vg_name\"; then\n    log \"Extending VG $vg_name with $part\"\n    vgextend \"$vg_name\" \"$part\"\n  fi\n\n  lv_path=\"/dev/$vg_name/$lv_name\"\n\n  lv_size_mb=\"$(lvs --noheadings --units m --nosuffix -o lv_size \"$lv_path\" | awk '{print $1}')\"\n  pv_free_mb=\"$(pvs --noheadings --units m --nosuffix -o pv_free \"$part\" | awk '{print $1}')\"\n\n  if command -v pvmove >/dev/null 2>&1 && \\\n     awk -v free=\"$pv_free_mb\" -v need=\"$lv_size_mb\" 'BEGIN { exit (free+0 >= need+0) ? 0 : 1 }'; then\n    # If the new disk can fully hold lv_log, move all extents to it.\n    log \"Attempting to move $lv_path to $part\"\n    cur_pvs=\"$(lvs --noheadings -o devices \"$lv_path\" | tr ',' '\\n' | awk '{print $1}' | sed 's/(.*)//' | sort -u)\"\n    moved_ok=1\n    for pv in $cur_pvs; do\n      if [ \"$pv\" != \"$part\" ]; then\n        if ! pvmove -n \"$lv_name\" \"$pv\" \"$part\"; then\n          moved_ok=0\n          break\n        fi\n      fi\n    done\n    if [ \"$moved_ok\" -eq 1 ]; then\n      log \"Setting LV allocation policy to cling\"\n      lvchange --alloc cling \"$lv_path\" || true\n      log \"Extending $lv_path to use all free space on $part\"\n      lvextend -l +100%FREE \"$lv_path\" \"$part\"\n      xfs_growfs /var/log\n      log \"LVM move+extend complete for /var/log\"\n      return 0\n    fi\n  fi\n\n  log \"Extending $lv_path to use all free space\"\n  lvextend -l +100%FREE \"$lv_path\"\n  xfs_growfs /var/log\n  log \"LVM extend complete for /var/log\"\n  return 0\n}\n\n# Pick the Azure data disk via LUN when possible (stable), then fallback.\n# You can override by exporting DATA_DISK_LUN (e.g., 0,1,2).\npick_data_disk() {\n  local lun_dir=\"/dev/disk/azure/scsi1\"\n  local lun_path=\"\"\n  local lun=\"${DATA_DISK_LUN:-}\"\n\n  if [ -d \"$lun_dir\" ]; then\n    if [ -n \"$lun\" ] && [ -e \"$lun_dir/lun$lun\" ]; then\n      lun_path=\"$lun_dir/lun$lun\"\n    else\n      lun_path=\"$(ls \"$lun_dir\"/lun* 2>/dev/null | sort -V | head -n1 || true)\"\n    fi\n\n    if [ -n \"$lun_path\" ] && [ -e \"$lun_path\" ]; then\n      local dev\n      dev=\"$(resolve_symlink \"$lun_path\")\"\n      log \"Using Azure data disk: $lun_path -> $dev\"\n      echo \"$lun_path\"\n      return 0\n    fi\n  fi\n\n  # Fallback mode: avoid OS disk and any mounted partitions.\n  log \"Detecting OS disk(s) from mounts...\"\n  local os_src log_src\n  os_src=\"$(get_mount_source /)\"\n  log_src=\"$(get_mount_source /var/log)\"\n  log \"Root mounted from: ${os_src:-<unknown>}\"\n  log \"/var/log mounted from: ${log_src:-<unknown>}\"\n\n  log \"Enumerating candidate disks...\"\n  # Use /sys/block to avoid needing lsblk (not always present)\n  local fallback=\"\"\n  for b in /sys/block/sd*; do\n    local d=\"/dev/$(basename \"$b\")\"\n\n    # Skip if not a block device\n    [ -b \"$d\" ] || continue\n\n    # Skip OS disk by name\n    if [[ \"$d\" == \"/dev/sda\" ]]; then\n      log \"Skipping OS disk: $d\"\n      continue\n    fi\n\n    # Skip if this disk is already used by root or /var/log source\n    # (covers cases where SOURCE is /dev/mapper/...; we do a best-effort check)\n    if echo \"$os_src $log_src\" | grep -q \"$(basename \"$d\")\"; then\n      log \"Skipping in-use disk: $d\"\n      continue\n    fi\n\n    # Skip disks that are actively used as swap\n    if grep -q \"^$d[[:space:]]\" /proc/swaps 2>/dev/null; then\n      log \"Skipping swap disk: $d\"\n      continue\n    fi\n\n    if disk_has_mounted_partitions \"$d\"; then\n      log \"Skipping disk with mounted partitions: $d\"\n      continue\n    fi\n\n    local ss\n    ss=\"$(get_logical_sector_size \"$d\")\"\n    log \"Candidate disk found: $d (logical sector size ${ss:-unknown})\"\n\n    # Prefer 4K logical sector disks (Premium SSD v2).\n    if [ -n \"$ss\" ] && [ \"$ss\" -ge 4096 ]; then\n      echo \"$d\"\n      return 0\n    fi\n\n    # Keep first non-4K candidate as a fallback.\n    if [ -z \"$fallback\" ]; then\n      fallback=\"$d\"\n    fi\n  done\n\n  if [ -n \"$fallback\" ]; then\n    echo \"$fallback\"\n    return 0\n  fi\n\n  return 1\n}\n\n# ----------------------------\n# Main\n# ----------------------------\n\n# If /var/log is already mounted on a non-root disk and has 4K sectsz, we can treat it as done.\nif is_mounted /var/log; then\n  cur_src=\"$(get_mount_source /var/log)\"\n  echo \"/var/log already mounted from: ${cur_src:-<unknown>}\"\nfi\n\nDATA_DISK=\"$(pick_data_disk || true)\"\nif [ -z \"${DATA_DISK:-}\" ]; then\n  fail \"Could not detect a non-OS data disk. Ensure a second disk is attached (LUN 1).\"\nfi\n\necho \"Selected data disk: $DATA_DISK\"\n\n# Wait for disk to be present\nwait_for_blockdev \"$DATA_DISK\" 60 2 || fail \"Disk $DATA_DISK did not appear.\"\n\n# Enforce 4K logical sector size to prevent misaligned I/O on Premium SSD v2.\nREQUIRE_4K=\"${REQUIRE_4K:-1}\"\ndata_disk_ss=\"$(get_logical_sector_size \"$(resolve_symlink \"$DATA_DISK\")\")\"\nif [ \"$REQUIRE_4K\" -eq 1 ]; then\n  if [ -z \"$data_disk_ss\" ]; then\n    fail \"Could not detect logical sector size for $DATA_DISK; refusing to proceed.\"\n  fi\n  if [ \"$data_disk_ss\" -lt 4096 ]; then\n    fail \"Selected data disk $DATA_DISK has logical sector size ${data_disk_ss}B; Premium SSD v2 requires 4K.\"\n  fi\nfi\n\n# If the disk is used as swap, disable it before we modify partitioning.\nswapoff_if_active \"$DATA_DISK\" || fail \"Failed to disable swap on $DATA_DISK\"\n\n# If /var/log is an LVM LV, extend it with the new disk and exit.\nif extend_var_log_lvm \"$DATA_DISK\"; then\n  report_final_layout\n  touch /var/log/cp-bootstrap-varlog.SUCCESS\n  echo \"BOOTSTRAP SUCCESS: $(date -Is)\"\n  exit 0\nfi\n\n# Sanity: show sector sizes\necho \"Sector sizes:\"\necho \"/dev/sda: $(blockdev --getss /dev/sda 2>/dev/null || echo n/a)\"\necho \"$DATA_DISK: $(blockdev --getss \"$(resolve_symlink \"$DATA_DISK\")\" 2>/dev/null || echo n/a)\"\n\n# Partition: create GPT + single partition (100%) if needed.\nPART=\"$(get_part_path \"$DATA_DISK\")\"\n\necho \"Checking if partition exists: $PART\"\nif [ ! -b \"$PART\" ]; then\n  echo \"Partition not found. Creating GPT and a single primary partition on $DATA_DISK\"\n  # Gaia usually has parted. If not, fail with clear message.\n  command -v parted >/dev/null 2>&1 || fail \"parted not found. Cannot partition disk.\"\n  parted -s \"$DATA_DISK\" mklabel gpt\n  parted -s \"$DATA_DISK\" mkpart primary 1MiB 100%\n  parted -s \"$DATA_DISK\" set 1 lvm on || true\n  wait_for_partitions \"$DATA_DISK\"\nfi\n\n# Wait for partition node\nwait_for_blockdev \"$PART\" 20 1 || fail \"Partition $PART did not appear.\"\n\necho \"Partition ready: $PART\"\n\nswapoff_if_active \"$PART\" || fail \"Failed to disable swap on $PART\"\n\n# If already has filesystem and is mounted on /var/log, finish.\nif is_mounted /var/log; then\n  echo \"/var/log is already mounted. Verifying sectsz...\"\n  if xfs_info /var/log >/dev/null 2>&1; then\n    sect=\"$(get_xfs_sectsz)\"\n    echo \"Current /var/log XFS sectsz=$sect\"\n    if [ \"$sect\" = \"4096\" ]; then\n      echo \"Already correct (4K). Marking success.\"\n      touch /var/log/cp-bootstrap-varlog.SUCCESS\n      echo \"BOOTSTRAP SUCCESS: $(date -Is)\"\n      exit 0\n    else\n      echo \"Mounted but sectsz is not 4096. Continuing with migration steps.\"\n    fi\n  else\n    echo \"/var/log is mounted but not XFS? Continuing with migration steps.\"\n  fi\nfi\n\n# Detect existing filesystem on partition\nif blkid \"$PART\" >/dev/null 2>&1; then\n  echo \"WARNING: $PART already has a filesystem signature:\"\n  blkid \"$PART\" || true\n  echo \"Because this is intended for a fresh deployment, we will REFORMAT $PART.\"\nelse\n  echo \"$PART appears empty (no blkid signature).\"\nfi\n\n# Prepare a safe staging mount under /mnt/newlog\nNEW_MNT=\"/mnt/newlog\"\nmkdir -p \"$NEW_MNT\"\n\n# Format as XFS with 4K sector size (required for Premium SSD v2 4K logical sectors)\necho \"Formatting $PART as XFS with 4K sectors...\"\ncommand -v mkfs.xfs >/dev/null 2>&1 || fail \"mkfs.xfs not found.\"\nmkfs.xfs -f -s size=4096 \"$PART\"\n\necho \"Mounting new filesystem at $NEW_MNT\"\nmount -t xfs \"$PART\" \"$NEW_MNT\"\n\n# Copy current /var/log contents (if any) to preserve anything already written\necho \"Copying existing /var/log contents into new filesystem...\"\nmkdir -p \"$NEW_MNT\"\n# Use rsync if available, else fallback to cp -a\nif command -v rsync >/dev/null 2>&1; then\n  rsync -aHAX --numeric-ids /var/log/ \"$NEW_MNT/\" || true\nelse\n  cp -a /var/log/. \"$NEW_MNT/\" || true\nfi\n\n# Swap mount: move old /var/log aside, mount new at /var/log\necho \"Switching /var/log to the new disk...\"\nOLD_LOG=\"/var/log.old\"\nmkdir -p \"$OLD_LOG\"\n\n# Try to stop key logging-related services if present (best-effort)\necho \"Best-effort: stopping syslog to avoid file churn during switch...\"\n( service syslog stop || service rsyslog stop || true ) 2>/dev/null || true\n\n# Bind-move: unmount stage then mount at /var/log\numount \"$NEW_MNT\"\n\n# If /var/log is currently a mountpoint, unmount it\nif is_mounted /var/log; then\n  echo \"/var/log is a mountpoint; unmounting it first...\"\n  umount /var/log || fail \"Failed to unmount existing /var/log\"\nfi\n\n# Move current directory content aside (only if /var/log is not a mount now)\n# We keep a backup just in case.\nif [ -d /var/log ] && [ ! -L /var/log ]; then\n  echo \"Backing up current /var/log to $OLD_LOG (best-effort)...\"\n  # Ensure /var/log exists\n  mkdir -p \"$OLD_LOG\"\n  # Copy rather than move to avoid breaking expected path structure if something fails\n  if command -v rsync >/dev/null 2>&1; then\n    rsync -aHAX --numeric-ids /var/log/ \"$OLD_LOG/\" || true\n  else\n    cp -a /var/log/. \"$OLD_LOG/\" || true\n  fi\nfi\n\n# Ensure mountpoint exists\nmkdir -p /var/log\n\necho \"Mounting $PART on /var/log\"\nmount -t xfs \"$PART\" /var/log\n\n# Persist in /etc/fstab (idempotent)\nUUID=\"$(blkid -s UUID -o value \"$PART\" || true)\"\nif [ -z \"$UUID\" ]; then\n  fail \"Could not read UUID for $PART\"\nfi\n\necho \"Persisting mount in /etc/fstab (UUID=$UUID)\"\nif grep -qE '^[^#].*\\s/var/log\\s' /etc/fstab; then\n  echo \"An existing /var/log entry exists in /etc/fstab. Updating it.\"\n  # Replace the existing /var/log line\n  cp -a /etc/fstab /etc/fstab.bak.$(date +%s)\n  # Use sed to replace the whole line that mounts /var/log\n  sed -i \"s|^[^#].*[[:space:]]/var/log[[:space:]].*$|UUID=$UUID /var/log xfs defaults,noatime 0 0|\" /etc/fstab\nelse\n  echo \"Adding new /var/log entry to /etc/fstab\"\n  echo \"UUID=$UUID /var/log xfs defaults,noatime 0 0\" >> /etc/fstab\nfi\n\n# Restart syslog best-effort\necho \"Best-effort: starting syslog again...\"\n( service syslog start || service rsyslog start || true ) 2>/dev/null || true\n\n# Final verification\necho \"Final verification:\"\nmount | grep \" /var/log \" || fail \"/var/log not mounted\"\ndf -h /var/log || true\nif xfs_info /var/log >/dev/null 2>&1; then\n  echo \"xfs_info:\"\n  xfs_info /var/log | egrep \"sectsz|bsize\" || true\nelse\n  fail \"/var/log is not XFS after mount\"\nfi\n\nsect=\"$(xfs_info /var/log | awk -F= '/sectsz=/{print $2; exit}' | awk '{print $1}')\"\nif [ \"$sect\" != \"4096\" ]; then\n  fail \"Expected /var/log XFS sectsz=4096, got sectsz=$sect\"\nfi\n\ntouch /var/log/cp-bootstrap-varlog.SUCCESS\necho \"BOOTSTRAP SUCCESS: $(date -Is)\"\nexit 0\n"
    },
    "bootstrapScriptUrl": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/roie9876/checkpoint-mgmt/main/cp-bootstrap-varlog-premiumv2.sh",
      "metadata": {
        "description": "URL of a bootstrap script to download and execute on first boot (used when bootstrapScript is empty). Leave empty to disable the VM extension."
      }
    },
    "enableApi": {
      "type": "string",
      "metadata": {
        "description": "Accept Management API calls (NOTE: Works only in version R81.10 and above)"
      },
      "defaultValue": "management_only",
      "allowedValues": [
        "management_only",
        "gui_clients",
        "all"
      ]
    },
    "allowDownloadFromUploadToCheckPoint": {
      "type": "string",
      "allowedValues": [
        "true",
        "false"
      ],
      "defaultValue": "true",
      "metadata": {
        "description": "Automatically download Blade Contracts and other important data. Improve product experience by sending data to Check Point"
      }
    },
    "additionalDiskSizeGB": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "Amount of additional disk space (in GB)"
      },
      "minValue": 0,
      "maxValue": 3995
    },
    "dataDiskV2SizeGB": {
      "type": "int",
      "defaultValue": 128,
      "minValue": 0,
      "maxValue": 4095,
      "metadata": {
        "description": "Size (GB) of an additional Premium SSD v2 data disk to attach at deployment time. Set 0 to skip. Note: Premium SSD v2 requires a zonal VM (Availability Zone)."
      }
    },
    "dataDiskLun": {
      "type": "int",
      "defaultValue": 0,
      "minValue": 0,
      "maxValue": 63,
      "metadata": {
        "description": "LUN number for the additional data disk."
      }
    },
    "dataDiskCaching": {
      "type": "string",
      "defaultValue": "None",
      "allowedValues": [
        "None",
        "ReadOnly",
        "ReadWrite"
      ],
      "metadata": {
        "description": "Caching mode for the additional data disk."
      }
    },
    "dataDiskCreateOption": {
      "type": "string",
      "defaultValue": "Empty",
      "allowedValues": [
        "Empty"
      ],
      "metadata": {
        "description": "Create option for the additional data disk."
      }
    },
    "deployPremiumV2DataDisk": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "If true and dataDiskV2SizeGB > 0, deploy and attach a Premium SSD v2 data disk."
      }
    },
    "diskType": {
      "type": "string",
      "defaultValue": "Premium_LRS",
      "metadata": {
        "description": "The type of the OS disk. Premium is applicable only to DS machine sizes"
      },
      "allowedValues": [
        "Standard_LRS",
        "Premium_LRS"
      ]
    },
    "msi": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Configure managed service identity for the VM"
      }
    },
    "sourceImageVhdUri": {
      "type": "string",
      "defaultValue": "noCustomUri",
      "metadata": {
        "description": "The URI of the blob containing the development image"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "Use the following URI when deploying a custom template: https://raw.githubusercontent.com/CheckPointSW/CloudGuardIaaS/master/azure/templates/"
      },
      "defaultValue": "https://raw.githubusercontent.com/CheckPointSW/CloudGuardIaaS/master/azure/templates/"
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated. Use the defaultValue if the staging location is not secured."
      },
      "defaultValue": ""
    },
    "tagsByResource": {
      "type": "object",
      "defaultValue": {}
    },
    "deployNewNSG": {
      "type": "bool",
      "defaultValue": true
    },
    "ExistingNSG": {
      "type": "object",
      "defaultValue": {}
    },
    "NewNsgName": {
      "type": "string",
      "defaultValue": "[concat(parameters('vmName'),'-nsg')]"
    },
    "storageAccountDeployMode": {
      "type": "string",
      "defaultValue": "New",
      "metadata": {
        "description": "Choose the Storage Account mode: 'New' creates a new account, 'Existing' uses one already available, 'Managed' provisions a managed account, and 'None' skips account creation."
      },
      "allowedValues": [
        "New",
        "Existing",
        "Managed",
        "None"
      ]
    },
    "addStorageAccountIpRules": {
      "type": "bool",
      "metadata": {
        "description": "Add Storage Account IP rules that allow access to the Serial Console only for IPs based on their geographic location, based on https://learn.microsoft.com/en-us/troubleshoot/azure/virtual-machines/serial-console-linux#use-serial-console-with-custom-boot-diagnostics-storage-account-firewall-enabled. Only relevant when 'Storage Account Deploy Mode' is set to 'New'."
      },
      "defaultValue": false
    },
    "storageAccountAdditionalIps": {
      "type": "array",
      "metadata": {
        "description": "IPs/CIDRs that are allowed access to the Storage Account. Format should be an array of strings. Only relevant when 'Storage Account Deploy Mode' is set to 'New'."
      },
      "defaultValue": []
    },
    "existingStorageAccountId": {
      "type": "string",
      "metadata": {
        "description": "The ID of the existing Storage Account. Only relevant when 'Storage Account Deploy Mode' is set to 'Existing'."
      },
      "defaultValue": ""
    }
  },
  "variables": {
    "templateName": "management",
    "templateVersion": "20240904",
    "nameSuffix": "[if(parameters('appendDeploymentSuffix'), concat('-', uniqueString(resourceGroup().id, deployment().name)), '')]",
    "vmNameEffective": "[concat(parameters('vmName'), variables('nameSuffix'))]",
    "nsgNameEffective": "[concat(variables('vmNameEffective'),'-nsg')]",
    "location": "[parameters('location')]",
    "offers": {
      "R81.10 - Bring Your Own License": "BYOL",
      "R81.10 - Pay As You Go (MGMT25)": "MGMT25",
      "R81.20 - Bring Your Own License": "BYOL",
      "R81.20 - Pay As You Go (MGMT25)": "MGMT25",
      "R82 - Bring Your Own License": "BYOL",
      "R82 - Pay As You Go (MGMT25)": "MGMT25"
    },
    "offer": "[variables('offers')[parameters('cloudGuardVersion')]]",
    "osVersions": {
      "R81.10 - Bring Your Own License": "R8110",
      "R81.10 - Pay As You Go (MGMT25)": "R8110",
      "R81.20 - Bring Your Own License": "R8120",
      "R81.20 - Pay As You Go (MGMT25)": "R8120",
      "R82 - Bring Your Own License": "R82",
      "R82 - Pay As You Go (MGMT25)": "R82"
    },
    "osVersion": "[variables('osVersions')[parameters('cloudGuardVersion')]]",
    "serialConsoleGeographies": {
      "eastasia": [
        "4.145.74.168",
        "20.195.85.180",
        "20.195.85.181",
        "20.205.68.106",
        "20.205.68.107",
        "20.205.69.28",
        "23.97.88.117",
        "23.98.106.151"
      ],
      "southeastasia": [
        "4.145.74.168",
        "20.195.85.180",
        "20.195.85.181",
        "20.205.68.106",
        "20.205.68.107",
        "20.205.69.28",
        "23.97.88.117",
        "23.98.106.151"
      ],
      "australiacentral": [
        "4.198.45.55",
        "4.200.251.224",
        "20.167.131.228",
        "20.53.52.250",
        "20.53.53.224",
        "20.53.55.174",
        "20.70.222.112",
        "20.70.222.113",
        "68.218.123.133"
      ],
      "australiacentral2": [
        "4.198.45.55",
        "4.200.251.224",
        "20.167.131.228",
        "20.53.52.250",
        "20.53.53.224",
        "20.53.55.174",
        "20.70.222.112",
        "20.70.222.113",
        "68.218.123.133"
      ],
      "australiaeast": [
        "4.198.45.55",
        "4.200.251.224",
        "20.167.131.228",
        "20.53.52.250",
        "20.53.53.224",
        "20.53.55.174",
        "20.70.222.112",
        "20.70.222.113",
        "68.218.123.133"
      ],
      "australiasoutheast": [
        "4.198.45.55",
        "4.200.251.224",
        "20.167.131.228",
        "20.53.52.250",
        "20.53.53.224",
        "20.53.55.174",
        "20.70.222.112",
        "20.70.222.113",
        "68.218.123.133"
      ],
      "brazilsouth": [
        "20.206.0.192",
        "20.206.0.193",
        "20.206.0.194",
        "20.226.211.157",
        "108.140.5.172",
        "191.234.136.63",
        "191.238.77.232",
        "191.238.77.233"
      ],
      "brazilsoutheast": [
        "20.206.0.192",
        "20.206.0.193",
        "20.206.0.194",
        "20.226.211.157",
        "108.140.5.172",
        "191.234.136.63",
        "191.238.77.232",
        "191.238.77.233"
      ],
      "canadacentral": [
        "20.175.7.183",
        "20.48.201.78",
        "20.48.201.79",
        "20.220.7.246",
        "52.139.106.74",
        "52.139.106.75",
        "52.228.86.177",
        "52.242.40.90"
      ],
      "canadaeast": [
        "20.175.7.183",
        "20.48.201.78",
        "20.48.201.79",
        "20.220.7.246",
        "52.139.106.74",
        "52.139.106.75",
        "52.228.86.177",
        "52.242.40.90"
      ],
      "northeurope": [
        "4.210.131.60",
        "20.105.209.72",
        "20.105.209.73",
        "40.113.178.49",
        "52.146.137.65",
        "52.146.139.220",
        "52.146.139.221",
        "98.71.107.78"
      ],
      "westeurope": [
        "4.210.131.60",
        "20.105.209.72",
        "20.105.209.73",
        "40.113.178.49",
        "52.146.137.65",
        "52.146.139.220",
        "52.146.139.221",
        "98.71.107.78"
      ],
      "francecentral": [
        "20.111.0.244",
        "40.80.103.247",
        "51.138.215.126",
        "51.138.215.127",
        "52.136.191.8",
        "52.136.191.9",
        "52.136.191.10",
        "98.66.128.35"
      ],
      "francesouth": [
        "20.111.0.244",
        "40.80.103.247",
        "51.138.215.126",
        "51.138.215.127",
        "52.136.191.8",
        "52.136.191.9",
        "52.136.191.10",
        "98.66.128.35"
      ],
      "germanynorth": [
        "20.52.94.114",
        "20.52.94.115",
        "20.52.95.48",
        "20.113.251.155",
        "51.116.75.88",
        "51.116.75.89",
        "51.116.75.90",
        "98.67.183.186"
      ],
      "germanywestcentral": [
        "20.52.94.114",
        "20.52.94.115",
        "20.52.95.48",
        "20.113.251.155",
        "51.116.75.88",
        "51.116.75.89",
        "51.116.75.90",
        "98.67.183.186"
      ],
      "centralindia": [
        "4.187.107.68",
        "20.192.47.134",
        "20.192.47.135",
        "20.192.152.150",
        "20.192.152.151",
        "20.192.153.104",
        "20.207.175.96",
        "52.172.82.199",
        "98.70.20.180"
      ],
      "southindia": [
        "4.187.107.68",
        "20.192.47.134",
        "20.192.47.135",
        "20.192.152.150",
        "20.192.152.151",
        "20.192.153.104",
        "20.207.175.96",
        "52.172.82.199",
        "98.70.20.180"
      ],
      "westindia": [
        "4.187.107.68",
        "20.192.47.134",
        "20.192.47.135",
        "20.192.152.150",
        "20.192.152.151",
        "20.192.153.104",
        "20.207.175.96",
        "52.172.82.199",
        "98.70.20.180"
      ],
      "japaneast": [
        "20.18.7.188",
        "20.43.70.205",
        "20.89.12.192",
        "20.89.12.193",
        "20.189.194.100",
        "20.189.228.222",
        "20.189.228.223",
        "20.210.144.254"
      ],
      "japanwest": [
        "20.18.7.188",
        "20.43.70.205",
        "20.89.12.192",
        "20.89.12.193",
        "20.189.194.100",
        "20.189.228.222",
        "20.189.228.223",
        "20.210.144.254"
      ],
      "koreacentral": [
        "20.200.166.136",
        "20.200.194.238",
        "20.200.194.239",
        "20.200.196.96",
        "20.214.133.81",
        "52.147.119.28",
        "52.147.119.29",
        "52.147.119.30"
      ],
      "koreasouth": [
        "20.200.166.136",
        "20.200.194.238",
        "20.200.194.239",
        "20.200.196.96",
        "20.214.133.81",
        "52.147.119.28",
        "52.147.119.29",
        "52.147.119.30"
      ],
      "norwaywest": [
        "20.100.1.154",
        "20.100.1.155",
        "20.100.1.184",
        "20.100.21.182",
        "51.13.138.76",
        "51.13.138.77",
        "51.13.138.78",
        "51.120.183.54"
      ],
      "norwayeast": [
        "20.100.1.154",
        "20.100.1.155",
        "20.100.1.184",
        "20.100.21.182",
        "51.13.138.76",
        "51.13.138.77",
        "51.13.138.78",
        "51.120.183.54"
      ],
      "switzerlandnorth": [
        "20.199.207.188",
        "20.208.4.98",
        "20.208.4.99",
        "20.208.4.120",
        "20.208.149.229",
        "51.107.251.190",
        "51.107.251.191",
        "51.107.255.176"
      ],
      "switzerlandwest": [
        "20.199.207.188",
        "20.208.4.98",
        "20.208.4.99",
        "20.208.4.120",
        "20.208.149.229",
        "51.107.251.190",
        "51.107.251.191",
        "51.107.255.176"
      ],
      "uaecentral": [
        "20.38.141.5",
        "20.45.95.64",
        "20.45.95.65",
        "20.45.95.66",
        "20.203.93.198",
        "20.233.132.205",
        "40.120.87.50",
        "40.120.87.51"
      ],
      "uaenorth": [
        "20.38.141.5",
        "20.45.95.64",
        "20.45.95.65",
        "20.45.95.66",
        "20.203.93.198",
        "20.233.132.205",
        "40.120.87.50",
        "40.120.87.51"
      ],
      "uksouth": [
        "20.58.68.62",
        "20.58.68.63",
        "20.90.32.180",
        "20.90.132.144",
        "20.90.132.145",
        "51.104.30.169",
        "172.187.0.26",
        "172.187.65.53"
      ],
      "ukwest": [
        "20.58.68.62",
        "20.58.68.63",
        "20.90.32.180",
        "20.90.132.144",
        "20.90.132.145",
        "51.104.30.169",
        "172.187.0.26",
        "172.187.65.53"
      ],
      "swedencentral": [
        "20.91.100.236",
        "51.12.22.174",
        "51.12.22.175",
        "51.12.22.204",
        "51.12.72.222",
        "51.12.72.223",
        "51.12.73.92",
        "172.160.216.6"
      ],
      "swedensouth": [
        "20.91.100.236",
        "51.12.22.174",
        "51.12.22.175",
        "51.12.22.204",
        "51.12.72.222",
        "51.12.72.223",
        "51.12.73.92",
        "172.160.216.6"
      ],
      "centralus": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "eastus2": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "eastus": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "northcentralus": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "southcentralus": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "westus2": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "westus3": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "westcentralus": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "westus": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "eastus2euap": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "centraluseuap": [
        "4.149.249.197",
        "4.150.239.210",
        "20.14.127.175",
        "20.40.200.175",
        "20.45.242.18",
        "20.45.242.19",
        "20.45.242.20",
        "20.47.232.186",
        "20.51.21.252",
        "20.69.5.160",
        "20.69.5.161",
        "20.69.5.162",
        "20.83.222.100",
        "20.83.222.101",
        "20.83.222.102",
        "20.98.146.84",
        "20.98.146.85",
        "20.98.194.64",
        "20.98.194.65",
        "20.98.194.66",
        "20.168.188.34",
        "20.241.116.153",
        "52.159.214.194",
        "57.152.124.244",
        "68.220.123.194",
        "74.249.127.175",
        "74.249.142.218",
        "157.55.93.0",
        "168.61.232.59",
        "172.183.234.204",
        "172.191.219.35"
      ],
      "usgovarizona": [
        "20.140.104.48",
        "20.140.105.3",
        "20.140.144.58",
        "20.140.144.59",
        "20.140.147.168",
        "20.140.53.121",
        "20.141.10.130",
        "20.141.10.131",
        "20.141.13.121",
        "20.141.15.104",
        "52.127.55.131",
        "52.235.252.252",
        "52.235.252.253",
        "52.243.247.124",
        "52.245.155.139",
        "52.245.156.185",
        "62.10.196.24",
        "62.10.196.25",
        "62.10.84.240",
        "62.11.6.64",
        "62.11.6.65"
      ],
      "usgovvirginia": [
        "20.140.104.48",
        "20.140.105.3",
        "20.140.144.58",
        "20.140.144.59",
        "20.140.147.168",
        "20.140.53.121",
        "20.141.10.130",
        "20.141.10.131",
        "20.141.13.121",
        "20.141.15.104",
        "52.127.55.131",
        "52.235.252.252",
        "52.235.252.253",
        "52.243.247.124",
        "52.245.155.139",
        "52.245.156.185",
        "62.10.196.24",
        "62.10.196.25",
        "62.10.84.240",
        "62.11.6.64",
        "62.11.6.65"
      ],
      "usgovtexas": [
        "20.140.104.48",
        "20.140.105.3",
        "20.140.144.58",
        "20.140.144.59",
        "20.140.147.168",
        "20.140.53.121",
        "20.141.10.130",
        "20.141.10.131",
        "20.141.13.121",
        "20.141.15.104",
        "52.127.55.131",
        "52.235.252.252",
        "52.235.252.253",
        "52.243.247.124",
        "52.245.155.139",
        "52.245.156.185",
        "62.10.196.24",
        "62.10.196.25",
        "62.10.84.240",
        "62.11.6.64",
        "62.11.6.65"
      ]
    },
    "serialConsoleIps": "[if(contains(variables('serialConsoleGeographies'),variables('location')),variables('serialConsoleGeographies')[variables('location')],createArray())]",
    "storageAccountIps": "[concat(variables('SerialConsoleIps'),parameters('storageAccountAdditionalIps'))]",
    "isBlink": "[bool('false')]",
    "storageAccountName": "[concat('bootdiag', uniqueString(resourceGroup().id, deployment().name))]",
    "storageAccountType": "Standard_LRS",
    "diskSize100GB": 100,
    "diskSizeGB": "[add(parameters('additionalDiskSizeGB'), variables('diskSize100GB'))]",
    "dataDiskName": "[concat(variables('vmNameEffective'), '-datadisk-v2')]",
    "deployDataDisk": "[and(parameters('deployPremiumV2DataDisk'), greater(parameters('dataDiskV2SizeGB'), 0))]",
    "customData": "[concat('#!/usr/bin/python3 /etc/cloud_config.py\n', '\n', 'installationType=\"', parameters('installationType'), '\"', '\n', 'allowUploadDownload=\"', variables('allowUploadDownload'), '\"', '\n', 'osVersion=\"', variables('osVersion'), '\"', '\n', 'templateName=\"', variables('templateName'), '\"', '\n', 'isBlink=\"', variables('isBlink'), '\"', '\n', 'templateVersion=\"', variables('templateVersion'), '\"', '\n', 'bootstrapScript64=\"', variables('bootstrapScript64'), '\"', '\n', 'location=\"', variables('location'), '\"', '\n', 'managementGUIClientNetwork=\"', variables('managementGUIClientNetwork'), '\"', '\n', 'enableApi=\"', parameters('enableApi'), '\"', '\n', 'adminShell=\"', parameters('adminShell'), '\"', '\n', 'MaintenanceModePassword=\"', parameters('MaintenanceModePasswordHash'), '\"', '\n', 'passwordHash=\"', parameters('SerialConsolePasswordHash'), '\"', '\n')]",
    "customData64": "[base64(variables('customData'))]",
    "imageOffer": "[concat('check-point-cg-', toLower(variables('osVersion')))]",
    "imagePublisher": "checkpoint",
    "imageReferenceBYOL": {
      "offer": "[variables('imageOffer')]",
      "publisher": "[variables('imagePublisher')]",
      "sku": "mgmt-byol",
      "version": "latest"
    },
    "imageReferenceMGMT25": {
      "offer": "[variables('imageOffer')]",
      "publisher": "[variables('imagePublisher')]",
      "sku": "mgmt-25",
      "version": "latest"
    },
    "imageReferenceMarketplace": "[if(equals(variables('offer'), 'BYOL'), variables('imageReferenceBYOL'), variables('imageReferenceMGMT25'))]",
    "customImage": "customImage",
    "imageReferenceCustomUri": {
      "id": "[resourceId('Microsoft.Compute/images/', variables('customImage'))]"
    },
    "imageReference": "[if(equals(parameters('sourceImageVhdUri'),'noCustomUri'), variables('imageReferenceMarketplace'), variables('imageReferenceCustomUri'))]",
    "nic1Name": "[concat(variables('vmNameEffective'), '-eth0')]",
    "linuxConfigurationpassword": {
      "disablePasswordAuthentication": "false"
    },
    "linuxConfigurationsshPublicKey": {
      "disablePasswordAuthentication": "true",
      "ssh": {
        "publicKeys": [
          {
            "keyData": "[parameters('sshPublicKey')]",
            "path": "/home/notused/.ssh/authorized_keys"
          }
        ]
      }
    },
    "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'),  variables('linuxConfigurationpassword'), variables('linuxConfigurationsshPublicKey'))]",
    "planBYOL": {
      "name": "mgmt-byol",
      "product": "[variables('imageOffer')]",
      "publisher": "[variables('imagePublisher')]"
    },
    "planMGMT25": {
      "name": "mgmt-25",
      "product": "[variables('imageOffer')]",
      "publisher": "[variables('imagePublisher')]"
    },
    "plan": "[if(equals(variables('offer'), 'BYOL'), variables('planBYOL'), variables('planMGMT25'))]",
    "identity": "[if(parameters('msi'), json('{\"type\": \"SystemAssigned\"}'), json('null'))]",
    "publicIPAddressName": "[variables('vmNameEffective')]",
    "publicIPAddressId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]",
    "bootstrapLogPath": "/var/log/cp-bootstrap-varlog.log",
    "bootstrapSuccessPath": "/var/log/cp-bootstrap-varlog.SUCCESS",
    "deployBootstrapExtension": "[not(equals(parameters('bootstrapScriptUrl'), ''))]",
    "bootstrapScriptEffective": "[if(equals(parameters('bootstrapScript'), ''), concat(\n    '#!/bin/bash\n',\n    'set -euo pipefail\n',\n    'LOG=/var/log/cp-bootstrap-varlog.log\n',\n    'mkdir -p /var/log\n',\n    'exec > >(tee -a \"$LOG\") 2>&1\n',\n    'echo \"[cp-bootstrap] start $(date -Is)\"\n',\n    'URL=\"', parameters('bootstrapScriptUrl'), '\"\n',\n    'if [ -z \"$URL\" ]; then\n',\n    '  echo \"[cp-bootstrap] no bootstrapScriptUrl provided; skipping\"\n',\n    '  exit 0\n',\n    'fi\n',\n    'OUT=/var/tmp/cp-bootstrap.sh\n',\n    'echo \"[cp-bootstrap] downloading $URL\"\n',\n    'ok=0\n',\n    'for i in $(seq 1 60); do\n',\n    '  if command -v curl >/dev/null 2>&1; then\n',\n    '    curl -fsSLk --connect-timeout 5 --max-time 30 \"$URL\" -o \"$OUT\"\n',\n    '  elif command -v wget >/dev/null 2>&1; then\n',\n    '    wget --no-check-certificate -qO \"$OUT\" \"$URL\"\n',\n    '  elif command -v python3 >/dev/null 2>&1; then\n',\n    '    python3 -c \"import ssl, urllib.request; ctx=ssl._create_unverified_context(); data=urllib.request.urlopen(\\\"$URL\\\", context=ctx).read(); open(\\\"$OUT\\\", \\\"wb\\\").write(data)\"\n',\n    '  elif command -v python >/dev/null 2>&1; then\n',\n    '    python -c \"import ssl, urllib2; ctx=ssl._create_unverified_context(); data=urllib2.urlopen(\\\"$URL\\\", context=ctx).read(); open(\\\"$OUT\\\", \\\"wb\\\").write(data)\"\n',\n    '  else\n',\n    '    echo \"[cp-bootstrap] ERROR: no downloader (curl/wget/python) available\"\n',\n    '    break\n',\n    '  fi\n',\n    '  if [ -s \"$OUT\" ]; then ok=1; break; fi\n',\n    '  echo \"[cp-bootstrap] download attempt $i failed, retrying in 10s\"\n',\n    '  sleep 10\n',\n    'done\n',\n    'if [ \"$ok\" -ne 1 ]; then\n',\n    '  echo \"[cp-bootstrap] ERROR: failed to download bootstrap script after retries\"\n',\n    '  exit 11\n',\n    'fi\n',\n    'chmod +x \"$OUT\"\n',\n    'echo \"[cp-bootstrap] executing $OUT\"\n',\n    'DATA_DISK_LUN=', string(parameters('dataDiskLun')), '\n',\n    'REQUIRE_4K=1\n',\n    '/bin/bash -x \"$OUT\"\n',\n    'echo \"[cp-bootstrap] finished $(date -Is)\"\n',\n    'touch /var/log/cp-bootstrap-varlog.SUCCESS\n'\n  ), parameters('bootstrapScript'))]",
    "bootstrapScript64": "[base64(variables('bootstrapScriptEffective'))]",
    "allowUploadDownload": "[parameters('allowDownloadFromUploadToCheckPoint')]",
    "_artifactsLocation": "[if(contains(parameters('_artifactsLocation'),'raw.githubusercontent.com/CheckPointSW/CloudGuardIaaS/master/azure/templates/marketplace'),'https://raw.githubusercontent.com/CheckPointSW/CloudGuardIaaS/master/azure/templates/',parameters('_artifactsLocation'))]",
    "networkSetupURL": "[uri(variables('_artifactsLocation'), concat('nestedtemplates/vnet-1-subnet-', parameters('vnetNewOrExisting'), '.json', parameters('_artifactsLocationSasToken')))]",
    "managementGUIClientNetwork": "[parameters('managementGUIClientNetwork')]",
    "deployNewVnet": "[equals(parameters('vnetNewOrExisting'), 'new')]",
    "vnetRGName": "[if(variables('deployNewVnet'), resourceGroup().name, parameters('virtualNetworkExistingRGName'))]",
    "NewNsgReference": {
      "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgNameEffective'))]"
    }
  },
  "resources": [
    {
      "condition": "[variables('deployDataDisk')]",
      "type": "Microsoft.Compute/disks",
      "apiVersion": "2023-10-02",
      "name": "[variables('dataDiskName')]",
      "location": "[variables('location')]",
      "zones": [
        "[parameters('availabilityZone')]"
      ],
      "sku": {
        "name": "PremiumV2_LRS"
      },
      "properties": {
        "creationData": {
          "createOption": "[parameters('dataDiskCreateOption')]"
        },
        "diskSizeGB": "[parameters('dataDiskV2SizeGB')]"
      },
      "tags": "[ if(contains(parameters('tagsByResource'), 'Microsoft.Compute/disks'), parameters('tagsByResource')['Microsoft.Compute/disks'], json('{}')) ]"
    },
    {
      "apiVersion": "2020-06-01",
      "name": "pid-6f13b00a-7546-4ab2-be9f-c66815cc6c8b-partnercenter",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },
    {
      "condition": "[equals(parameters('storageAccountDeployMode'), 'New')]",
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('storageAccountName')]",
      "apiVersion": "2022-09-01",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "allowBlobPublicAccess": false,
        "minimumTlsVersion": "TLS1_2",
        "networkAcls": {
          "bypass": "None",
          "defaultAction": "[if(parameters('addStorageAccountIpRules'), 'Deny', 'Allow')]",
          "ipRules": "[if(parameters('addStorageAccountIpRules'), map(variables('storageAccountIps'), lambda('ip',createObject('action','Allow','value',lambdaVariables('ip')))), createArray())]"
        }
      },
      "location": "[variables('location')]",
      "sku": {
        "name": "[variables('storageAccountType')]"
      },
      "kind": "StorageV2",
      "tags": "[ if(contains(parameters('tagsByResource'), 'Microsoft.Storage/storageAccounts'), parameters('tagsByResource')['Microsoft.Storage/storageAccounts'], json('{}')) ]"
    },
    {
      "condition": "[equals(parameters('vnetNewOrExisting'), 'new')]",
      "name": "networkNewSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('networkSetupURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "virtualNetworkName": {
            "value": "[parameters('virtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('virtualNetworkAddressPrefix')]"
          },
          "Subnet1Name": {
            "value": "[parameters('Subnet1Name')]"
          },
          "Subnet1Prefix": {
            "value": "[parameters('Subnet1Prefix')]"
          },
          "deployNsg": {
            "value": false
          },
          "NewNsgName": {
            "value": "[variables('nsgNameEffective')]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          }
        }
      }
    },
    {
      "condition": "[equals(parameters('vnetNewOrExisting'), 'existing')]",
      "name": "networkExistingSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('networkSetupURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "virtualNetworkName": {
            "value": "[parameters('virtualNetworkName')]"
          },
          "virtualNetworkExistingRGName": {
            "value": "[variables('vnetRGName')]"
          },
          "vmName": {
            "value": "[parameters('vmName')]"
          },
          "deployNsg": {
            "value": false
          },
          "NewNsgName": {
            "value": "[variables('nsgNameEffective')]"
          },
          "tagsByResource": {
            "value": "[parameters('tagsByResource')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2021-08-01",
      "location": "[variables('location')]",
      "zones": [
        "[parameters('availabilityZone')]"
      ],
      "name": "[variables('publicIPAddressName')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "idleTimeoutInMinutes": 30,
        "publicIPAllocationMethod": "Static",
        "dnsSettings": {
          "domainNameLabel": "[concat(toLower(parameters('vmName')), '-', uniquestring(resourceGroup().id, deployment().name))]"
        }
      },
      "tags": "[ if(contains(parameters('tagsByResource'), 'Microsoft.Network/publicIPAddresses'), parameters('tagsByResource')['Microsoft.Network/publicIPAddresses'], json('{}')) ]"
    },
    {
      "condition": "[parameters('deployNewNSG')]",
      "dependsOn": [
        "[variables('publicIPAddressId')]"
      ],
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2021-08-01",
      "location": "[variables('location')]",
      "name": "[variables('nsgNameEffective')]",
      "properties": {
        "securityRules": [
          {
            "name": "SSH",
            "properties": {
              "description": "Allow inbound SSH connection",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "[variables('managementGUIClientNetwork')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "100",
              "direction": "Inbound"
            }
          },
          {
            "name": "GAiA-portal",
            "properties": {
              "description": "Allow inbound HTTPS access to the GAiA portal",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "443",
              "sourceAddressPrefix": "[variables('managementGUIClientNetwork')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "110",
              "direction": "Inbound"
            }
          },
          {
            "name": "SmartConsole-1",
            "properties": {
              "description": "Allow inbound access using the SmartConsole GUI client",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "18190",
              "sourceAddressPrefix": "[variables('managementGUIClientNetwork')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "120",
              "direction": "Inbound"
            }
          },
          {
            "name": "SmartConsole-2",
            "properties": {
              "description": "Allow inbound access using the SmartConsole GUI client",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "19009",
              "sourceAddressPrefix": "[variables('managementGUIClientNetwork')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "130",
              "direction": "Inbound"
            }
          },
          {
            "name": "Logs",
            "properties": {
              "description": "Allow inbound logging connections from managed gateways",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "257",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "140",
              "direction": "Inbound"
            }
          },
          {
            "name": "ICA-pull",
            "properties": {
              "description": "Allow security gateways to pull a SIC certificate",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "18210",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "150",
              "direction": "Inbound"
            }
          },
          {
            "name": "CRL-fetch",
            "properties": {
              "description": "Allow security gateways to fetch CRLs",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "18264",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "160",
              "direction": "Inbound"
            }
          },
          {
            "name": "Policy-fetch",
            "properties": {
              "description": "Allow security gateways to fetch policy",
              "protocol": "TCP",
              "sourcePortRange": "*",
              "destinationPortRange": "18191",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "170",
              "direction": "Inbound"
            }
          },
          {
            "name": "Allow-self-IP-inbound",
            "properties": {
              "description": "Allow inbound traffic from the VM's public IP address",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "[reference(variables('publicIPAddressId')).IpAddress]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": "180",
              "direction": "Inbound"
            }
          }
        ]
      },
      "tags": "[ if(contains(parameters('tagsByResource'), 'Microsoft.Network/networkSecurityGroups'), parameters('tagsByResource')['Microsoft.Network/networkSecurityGroups'], json('{}')) ]"
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2021-08-01",
      "dependsOn": [
        "[if(equals(parameters('vnetNewOrExisting'), 'new'), resourceId('Microsoft.Resources/deployments', 'networkNewSetup'), resourceId('Microsoft.Resources/deployments', 'networkExistingSetup'))]",
        "[variables('publicIPAddressId')]",
        "[if(parameters('deployNewNSG'), resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgNameEffective')), variables('publicIPAddressId'))]"
      ],
      "location": "[variables('location')]",
      "name": "[variables('nic1Name')]",
      "properties": {
        "enableIPForwarding": false,
        "networkSecurityGroup": "[if(parameters('deployNewNSG') , variables('NewNsgReference') , parameters('ExistingNSG'))]",
        "ipConfigurations": "[if(parameters('appendDeploymentSuffix'), createArray(createObject('name','ipconfig1','properties',createObject('privateIPAllocationMethod','Dynamic','publicIPAddress',createObject('id',variables('publicIPAddressId')),'subnet',createObject('id',resourceId(variables('vnetRGName'),'Microsoft.Network/virtualNetworks/subnets',parameters('virtualNetworkName'),parameters('Subnet1Name')))))), createArray(createObject('name','ipconfig1','properties',createObject('privateIPAddress',parameters('Subnet1StartAddress'),'privateIPAllocationMethod','Static','publicIPAddress',createObject('id',variables('publicIPAddressId')),'subnet',createObject('id',resourceId(variables('vnetRGName'),'Microsoft.Network/virtualNetworks/subnets',parameters('virtualNetworkName'),parameters('Subnet1Name')))))))]"
      },
      "tags": "[ if(contains(parameters('tagsByResource'), 'Microsoft.Network/networkInterfaces'), parameters('tagsByResource')['Microsoft.Network/networkInterfaces'], json('{}')) ]"
    },
    {
      "condition": "[not(equals(parameters('sourceImageVhdUri'), 'noCustomUri'))]",
      "type": "Microsoft.Compute/images",
      "apiVersion": "2021-11-01",
      "name": "[variables('customImage')]",
      "location": "[variables('location')]",
      "properties": {
        "storageProfile": {
          "osDisk": {
            "osType": "Linux",
            "osState": "Generalized",
            "blobUri": "[parameters('sourceImageVhdUri')]",
            "storageAccountType": "Standard_LRS"
          }
        },
        "hyperVGeneration": "V1"
      },
      "tags": "[ if(contains(parameters('tagsByResource'), 'Microsoft.Compute/images'), parameters('tagsByResource')['Microsoft.Compute/images'], json('{}')) ]"
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2021-11-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', variables('nic1Name'))]",
        "[if(equals(parameters('storageAccountDeployMode'), 'New'), resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), resourceId('Microsoft.Network/networkInterfaces', variables('nic1Name')))]",
        "[if(variables('deployDataDisk'), resourceId('Microsoft.Compute/disks', variables('dataDiskName')), resourceId('Microsoft.Network/networkInterfaces', variables('nic1Name')))]",
        "[if(not(equals(parameters('sourceImageVhdUri'), 'noCustomUri')), resourceId('Microsoft.Compute/images', variables('customImage')), resourceId('Microsoft.Network/networkInterfaces', variables('nic1Name')))]"
      ],
      "location": "[variables('location')]",
      "zones": [
        "[parameters('availabilityZone')]"
      ],
      "name": "[variables('vmNameEffective')]",
      "plan": "[if(equals(parameters('sourceImageVhdUri'),'noCustomUri'), variables('plan'), json('null'))]",
      "identity": "[variables('identity')]",
      "properties": {
        "UserData": "[variables('customData64')]",
        "diagnosticsProfile": {
          "bootDiagnostics": "[if(equals(parameters('storageAccountDeployMode'), 'None'), createObject('enabled', false()), if(equals(parameters('storageAccountDeployMode'), 'Managed'), createObject('enabled', true()), createObject('enabled', true(), 'storageUri', if(equals(parameters('storageAccountDeployMode'), 'New'), reference(resourceId('Microsoft.Storage/storageAccounts/', variables('storageAccountName')), '2023-05-01').primaryEndpoints.blob, reference(parameters('existingStorageAccountId'), '2023-05-01').primaryEndpoints.blob))))]"
        },
        "hardwareProfile": {
          "vmSize": "[parameters('vmSize')]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nic1Name'))]",
              "properties": {
                "primary": true
              }
            }
          ]
        },
        "osProfile": {
          "adminPassword": "[parameters('adminPassword')]",
          "adminUsername": "[concat('not','used')]",
          "computerName": "[toLower(variables('vmNameEffective'))]",
          "customData": "[variables('customData64')]",
          "linuxConfiguration": "[variables('linuxConfiguration')]"
        },
        "storageProfile": {
          "imageReference": "[variables('imageReference')]",
          "osDisk": {
            "caching": "ReadWrite",
            "createOption": "FromImage",
            "diskSizeGB": "[variables('diskSizeGB')]",
            "name": "[variables('vmNameEffective')]",
            "managedDisk": {
              "storageAccountType": "[parameters('diskType')]"
            }
          },
          "dataDisks": "[if(variables('deployDataDisk'), createArray(createObject('lun', parameters('dataDiskLun'), 'name', variables('dataDiskName'), 'createOption', 'Attach', 'caching', parameters('dataDiskCaching'), 'managedDisk', createObject('id', resourceId('Microsoft.Compute/disks', variables('dataDiskName'))))), json('[]'))]"
        }
      },
      "tags": "[ if(contains(parameters('tagsByResource'), 'Microsoft.Compute/virtualMachines'), parameters('tagsByResource')['Microsoft.Compute/virtualMachines'], json('{}')) ]"
    },
    {
      "condition": "[variables('deployBootstrapExtension')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2022-11-01",
      "name": "[concat(variables('vmNameEffective'), '/cpBootstrap')]",
      "location": "[variables('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', variables('vmNameEffective'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "fileUris": [
            "[parameters('bootstrapScriptUrl')]"
          ]
        },
        "protectedSettings": {
          "commandToExecute": "[concat('/bin/bash -c \"set -euo pipefail; LOG=', variables('bootstrapLogPath'), '; OK=', variables('bootstrapSuccessPath'), '; mkdir -p /var/log; exec > >(tee -a $LOG) 2>&1; echo [cp-bootstrap-ext] start $(date -Is); SRC=/var/lib/waagent/custom-script/download/0/$(basename ', parameters('bootstrapScriptUrl'), '); echo [cp-bootstrap-ext] using $SRC; chmod +x $SRC; export DATA_DISK_LUN=', string(parameters('dataDiskLun')), '; export REQUIRE_4K=1; /bin/bash -x $SRC; echo [cp-bootstrap-ext] finished $(date -Is); touch $OK\"')]"
        }
      },
      "tags": "[ if(contains(parameters('tagsByResource'), 'Microsoft.Compute/virtualMachines/extensions'), parameters('tagsByResource')['Microsoft.Compute/virtualMachines/extensions'], json('{}')) ]"
    }
  ],
  "outputs": {
    "IPAddress": {
      "type": "string",
      "value": "[reference(variables('publicIPAddressId')).IpAddress]"
    },
    "FQDN": {
      "type": "string",
      "value": "[reference(variables('publicIPAddressId')).dnsSettings.fqdn]"
    },
    "BootstrapLogHint": {
      "type": "string",
      "value": "After first boot, check /var/log/cp-bootstrap-varlog.log and /var/log/cp-bootstrap-varlog.SUCCESS on the VM. These are written by the VM CustomScript extension cpBootstrap."
    }
  }
}
